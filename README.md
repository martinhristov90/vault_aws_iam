## This repository demonstrates Vault using AWS secret backend, running in EC2.

### Purpose:

### How it works :

- Terraform creates and provisions a one Vault server in AWS.
- There is not need to configure "root" access and secret AWS keys that Vault (AWS secret backend) is going to use for generating IAM credentials. Vault is going to assume a role by itself (EC2 instance profile), that has been generated by Terraform (roles.tf) and it is going to use it as "root" access and secret key (cool).

### Instructions : 

- Execute `git clone https://github.com/martinhristov90/vault_aws_iam.git`
- cd `vault_aws_iam`
- Execute `terraform init`, `terraform plan`, `terraform apply`
- Connect to the address shown in the output of TF.
- Setting up Vault :
    - Initializing manually using : `vault operator init  -key-shares=1 -key-threshold=1`
    - Unseal it with the one unseal key.
    - Login to Vault with the root token : `vault login YOUR_ROOT_TOKE_HERE`
    - Enable AWS secret engine : `vault secrets enable aws`.
    - There is not need to configure `aws/config/root` it is automatically going to use the instance_profile of the EC2.
    - ### Generating "iam_user" credentials ( regular AWS IAM user) :
      - In the current folder create a JSON file named `role.json` with the following content (this one gives   all permissions to EC2 service when role is used):
          ```
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Sid": "ec2Admin",
                "Effect": "Allow",
                "Action": ["ec2:*"],
                "Resource": ["*"]
              }
            ]
          }
          ```
      - Create simple AWS secret engine role (IAM user) using : `vault write aws/roles/my-role-iam-user   credential_type=iam_user policy_document=@role.json`.
      - Request a creation of brand new IAM AWS user by : `vault read aws/creds/my-role-iam-user`. Vault is   going to return to you access and secret AWS keys that are valid for any (`ec2:*`) operation.
          > Note : If the policy document is not valid, Vault is going to create user in AWS IAM, and error   is going to be returned, the user should be deleted manually from AWS console.
      - The key is valid for 768h (system default), to revoke it manually, execute : `vault lease revoke  -prefix aws/creds/my-role-iam-user`.
    - ### Generating "Assume role" credentials ( STS short-lived credentials ) :
      - Generating temporary credentials is ofter refered in AWS terminology as "Assuming role", alongside the `acceess_key` and the `secret_key` there is a `security_token` when temporary credentials are genereated.
      - Take a look at the `roles_additional.tf` file, it gives a permission to the role (`vault-iam-root-role`) used by Vault as `root` ( `aws/config/root` ) to assume the the role that we want to give to the user (create_ami role), so the user is going to get STS credentials for that role. 
      - To create a Vault role of `credential_type=assumed_role` use the following command: `vault write aws/roles/my-role-assume role_arns=arn:aws:iam::ACCOUNT_AWS_NUMBER:role/NAME_OF_create-ami_ROLE_HERE credential_type=assumed_role`
        > Note: `role_arns` not `role_arn` !!!
      - To generate STS credential (assuming role), execute the following command : `vault read aws/sts/my-role-assume` 
      - Response will look like :
      ```
        Key                Value
        ---                -----
        lease_id           aws/sts/my-role-assume/GyA2auuTasJp51MZnuxNhrb6
        lease_duration     1h
        lease_renewable    false
        access_key         ASIA<SNIP> # NOTE : ASIA for temporary STS creds
        secret_key         mMyoAqsyNvBPm4F/v0Ry<SNIP>
        security_token     FwoGZXIvYXdzEDsaDK+u<SNIP> # Security token is also returned, because it is STS creds.
      

## Security Notes :
- This is just testing setup, treat it as such.
- To use it in production, auth backend should be setup.